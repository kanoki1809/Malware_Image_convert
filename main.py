import streamlit as st
import numpy as np
import os
import subprocess
import array
import glob
from PIL import Image


def generate_image(input, output, fileName):

    out_file = os.path.splitext(os.path.basename(fileName))[0] + '.png' # lấy tên cơ sở của tệp tin PE (phần trước dấu chấm .) và thêm phần mở rộng .png để tạo tên tệp tin hình ảnh đầu ra.
    out_file_full = os.path.join(output, out_file) # tạo đường dẫn của hình ảnh đầu ra.
    input_file_path = os.path.join(input, fileName) # đường dẫn chứa tập PE

    if is_pe(fileName):
        open_pe = open(input_file_path, 'rb') # mở tệp tin để đọc trong chế độ nhị phân.
        len_pe = os.path.getsize(input_file_path)  #  lấy kích thước của tệp tin (độ dài tệp tin theo byte).
        width = 256 #chiều rộng ảnh
        rem = len_pe % width #kích thước dư
        a = array.array("B")  # tạo một mảng dữ liệu kiểu uint8 để lưu trữ thông tin hình ảnh
        a.fromfile(open_pe, len_pe - rem)#đọc nội dung tệp tin PE vào mảng dữ liệu hình ảnh, bỏ qua phần còn lại của tệp tin nếu kích thước không chia hết cho 256 byte.
        open_pe.close()
        g = numpy.reshape(a, (len(a) // width, width))# chuyển đổi mảng dữ liệu hình ảnh thành ma trận hình ảnh, có chiều rộng bằng 256 pixel.
        g = numpy.uint8(g) #chuyển đổi loại dữ liệu của ma trận hình ảnh thành uint8
        g = numpy.stack([g, g, g], axis=2) #chuyển đổi mảng dữ liệu thành mảng ba chiều
        g = Image.point([0, 255])
        g.save(out_file_full, g)
    else:
        print("not pe")

def convert_binary_to_img(input, output):

    count = 0
    files = os.listdir(input)# danh sách các tệp trong input
    print(files)
    for filename in files:
        try:
            generate_image(input, output, filename)
            count += 1
            if max == count:
                exit(0)
        except:
             print('error', filename)


folder= os.makedirs("image_folder")



st.title('CONVERT PE FILE TO  IMAGE')

st.write('CHOOSE TYPE TO CONVERT')
type=st.radio('choose  depent',['file','folder'])

if type=='file':
  file = st.file_uploader('choose a pe file: ', type=([".exe", ".dll", ".ocx", ".sys", ".ime", ".cpl", ".bpl", ".ime", ".tlb", ".ocx", ".res", ".ax"]))
  input = file
  output = folder
  image= convert_binary_to_img(input, output)
  Image.show();
else:
  uploaded_files = st.file_uploader("Upload your folder here...", accept_multiple_files=True, type=([".exe", ".dll", ".ocx", ".sys", ".ime", ".cpl", ".bpl", ".ime", ".tlb", ".ocx", ".res", ".ax"]))
  
  
